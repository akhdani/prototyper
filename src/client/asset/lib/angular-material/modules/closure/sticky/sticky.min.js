goog.provide("ng.material.components.sticky");goog.require("ng.material.components.content");goog.require("ng.material.core");angular.module("material.components.sticky",["material.core","material.components.content"]).factory("$mdSticky",MdSticky);function MdSticky($document,$mdConstant,$compile,$$rAF,$mdUtil){var browserStickySupport=checkStickySupport();return function registerStickyElement(scope,element,stickyClone){var contentCtrl=element.controller("mdContent");if(!contentCtrl)return;if(browserStickySupport){element.css({position:browserStickySupport,top:0,"z-index":2})}else{var $$sticky=contentCtrl.$element.data("$$sticky");if(!$$sticky){$$sticky=setupSticky(contentCtrl);contentCtrl.$element.data("$$sticky",$$sticky)}var deregister=$$sticky.add(element,stickyClone||element.clone());scope.$on("$destroy",deregister)}};function setupSticky(contentCtrl){var contentEl=contentCtrl.$element;var debouncedRefreshElements=$$rAF.throttle(refreshElements);setupAugmentedScrollEvents(contentEl);contentEl.on("$scrollstart",debouncedRefreshElements);contentEl.on("$scroll",onScroll);var self;var stickyBaseoffset=contentEl.prop("offsetTop");return self={prev:null,current:null,next:null,items:[],add:add,refreshElements:refreshElements};function add(element,stickyClone){stickyClone.addClass("md-sticky-clone");stickyClone.css("top",stickyBaseoffset+"px");var item={element:element,clone:stickyClone};self.items.push(item);contentEl.parent().prepend(item.clone);debouncedRefreshElements();return function remove(){self.items.forEach(function(item,index){if(item.element[0]===element[0]){self.items.splice(index,1);item.clone.remove()}});debouncedRefreshElements()}}function refreshElements(){self.items.forEach(refreshPosition);self.items=self.items.sort(function(a,b){return a.top<b.top?-1:1});var item;var currentScrollTop=contentEl.prop("scrollTop");for(var i=self.items.length-1;i>=0;i--){if(currentScrollTop>self.items[i].top){item=self.items[i];break}}setCurrentItem(item)}function refreshPosition(item){var current=item.element[0];item.top=0;item.left=0;while(current&&current!==contentEl[0]){item.top+=current.offsetTop;item.left+=current.offsetLeft;current=current.offsetParent}item.height=item.element.prop("offsetHeight");item.clone.css("margin-left",item.left+"px");if($mdUtil.floatingScrollbars()){item.clone.css("margin-right","0")}}function onScroll(){var scrollTop=contentEl.prop("scrollTop");var isScrollingDown=scrollTop>(onScroll.prevScrollTop||0);onScroll.prevScrollTop=scrollTop;if(scrollTop===0){setCurrentItem(null)}else if(isScrollingDown&&self.next){if(self.next.top-scrollTop<=0){setCurrentItem(self.next)}else if(self.current){if(self.next.top-scrollTop<=self.next.height){translate(self.current,self.next.top-self.next.height-scrollTop)}else{translate(self.current,null)}}}else if(!isScrollingDown&&self.current){if(scrollTop<self.current.top){setCurrentItem(self.prev)}if(self.current&&self.next){if(scrollTop>=self.next.top-self.current.height){translate(self.current,self.next.top-scrollTop-self.current.height)}else{translate(self.current,null)}}}}function setCurrentItem(item){if(self.current===item)return;if(self.current){translate(self.current,null);setStickyState(self.current,null)}if(item){setStickyState(item,"active")}self.current=item;var index=self.items.indexOf(item);self.next=self.items[index+1];self.prev=self.items[index-1];setStickyState(self.next,"next");setStickyState(self.prev,"prev")}function setStickyState(item,state){if(!item||item.state===state)return;if(item.state){item.clone.attr("sticky-prev-state",item.state);item.element.attr("sticky-prev-state",item.state)}item.clone.attr("sticky-state",state);item.element.attr("sticky-state",state);item.state=state}function translate(item,amount){if(!item)return;if(amount===null||amount===undefined){if(item.translateY){item.translateY=null;item.clone.css($mdConstant.CSS.TRANSFORM,"")}}else{item.translateY=amount;item.clone.css($mdConstant.CSS.TRANSFORM,"translate3d("+item.left+"px,"+amount+"px,0)")}}}function checkStickySupport($el){var stickyProp;var testEl=angular.element("<div>");$document[0].body.appendChild(testEl[0]);var stickyProps=["sticky","-webkit-sticky"];for(var i=0;i<stickyProps.length;++i){testEl.css({position:stickyProps[i],top:0,"z-index":2});if(testEl.css("position")==stickyProps[i]){stickyProp=stickyProps[i];break}}testEl.remove();return stickyProp}function setupAugmentedScrollEvents(element){var SCROLL_END_DELAY=200;var isScrolling;var lastScrollTime;element.on("scroll touchmove",function(){if(!isScrolling){isScrolling=true;$$rAF(loopScrollEvent);element.triggerHandler("$scrollstart")}element.triggerHandler("$scroll");lastScrollTime=+$mdUtil.now()});function loopScrollEvent(){if(+$mdUtil.now()-lastScrollTime>SCROLL_END_DELAY){isScrolling=false;element.triggerHandler("$scrollend")}else{element.triggerHandler("$scroll");$$rAF(loopScrollEvent)}}}}MdSticky.$inject=["$document","$mdConstant","$compile","$$rAF","$mdUtil"];ng.material.components.sticky=angular.module("material.components.sticky");